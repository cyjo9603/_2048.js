<!DOCTYPE html>
<html>
  <head>
    <title>_2048</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="reset.css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/earlyaccess/nanumgothic.css" />
    <script type="text/javascript">
      const gameData = {
        score: 0,
        state: 0,
        mode: 4,
        table: {
          current: {},
          before: {},
        },
      };

      function setGame() {
        let htmlText = '';
        for (let i = 0; i < gameData.mode; i++) {
          gameData.table.current[i] = new Object();
          gameData.table.before[i] = new Object();
          for (let j = 0; j < gameData.mode; j++) {
            htmlText += '<div class="block_' + gameData.mode + '" id="tb_' + i + j + '"></div>' + '\n';
            gameData.table.current[i][j] = null;
            gameData.table.before[i][j] = null;
          }
        }
        document.getElementById('gameboard1').className = 'gameboard_' + gameData.mode;
        document.getElementById('gameboard1').innerHTML = htmlText;
      }

      window.onkeyup = (e) => {
        if (gameData.state === 1) {
          datacopy();
          switch (e.keyCode) {
            case 37:
              for (let i = 0; i < gameData.mode; i++) {
                for (let j = 1; j < gameData.mode; j++) {
                  let space_cnt = 0;
                  for (let p = 0; p < j; p++) {
                    space_cnt += gameData.table.current[i][p] == null ? 1 : 0;
                  }
                  if (space_cnt !== 0) {
                    gameData.table.current[i][j - space_cnt] = gameData.table.current[i][j];
                    gameData.table.current[i][j] = null;
                  }
                  if (gameData.table.current[i][j - space_cnt - 1] === gameData.table.current[i][j - space_cnt]) {
                    gameData.table.current[i][j - space_cnt - 1] *= 2;
                    gameData.table.current[i][j - space_cnt] = null;
                    scoreupdate(gameData.table.current[i][j - space_cnt - 1]);
                  }
                }
              }
              break;
            case 38:
              for (let j = 0; j < gameData.mode; j++) {
                for (let i = 1; i < gameData.mode; i++) {
                  let space_cnt = 0;
                  for (let p = 0; p < i; p++) {
                    space_cnt += gameData.table.current[p][j] == null ? 1 : 0;
                  }
                  if (space_cnt !== 0) {
                    gameData.table.current[i - space_cnt][j] = gameData.table.current[i][j];
                    gameData.table.current[i][j] = null;
                  }
                  if (i - space_cnt - 1 > -1 && gameData.table.current[i - space_cnt][j] === gameData.table.current[i - space_cnt - 1][j]) {
                    gameData.table.current[i - space_cnt - 1][j] *= 2;
                    gameData.table.current[i - space_cnt][j] = null;
                    scoreupdate(gameData.table.current[i - space_cnt - 1][j]);
                  }
                }
              }
              break;
            case 39:
              for (let i = 0; i < gameData.mode; i++) {
                for (let j = gameData.mode - 2; j > -1; j--) {
                  let space_cnt = 0;
                  for (let p = gameData.mode - 1; p > j; p--) {
                    space_cnt += gameData.table.current[i][p] == null ? 1 : 0;
                  }
                  if (space_cnt !== 0) {
                    gameData.table.current[i][j + space_cnt] = gameData.table.current[i][j];
                    gameData.table.current[i][j] = null;
                  }
                  if (gameData.table.current[i][j + space_cnt] === gameData.table.current[i][j + space_cnt + 1]) {
                    gameData.table.current[i][j + space_cnt + 1] *= 2;
                    gameData.table.current[i][j + space_cnt] = null;
                    scoreupdate(gameData.table.current[i][j + space_cnt + 1]);
                  }
                }
              }
              break;
            case 40:
              for (let j = 0; j < gameData.mode; j++) {
                for (let i = gameData.mode - 2; i > -1; i--) {
                  let space_cnt = 0;
                  for (let p = gameData.mode - 1; p > i; p--) {
                    space_cnt += gameData.table.current[p][j] == null ? 1 : 0;
                  }
                  if (space_cnt !== 0) {
                    gameData.table.current[i + space_cnt][j] = gameData.table.current[i][j];
                    gameData.table.current[i][j] = null;
                  }
                  if (i + space_cnt + 1 < 4 && gameData.table.current[i + space_cnt][j] === gameData.table.current[i + space_cnt + 1][j]) {
                    gameData.table.current[i + space_cnt + 1][j] *= 2;
                    gameData.table.current[i + space_cnt][j] = null;
                    scoreupdate(gameData.table.current[i + space_cnt + 1][j]);
                  }
                }
              }
              break;
          }

          if (datacheck() !== gameData.mode * gameData.mode) creatnum();
          else if (fail_check() === 0) {
            gameData.state = 0;
            if (document.getElementById('bestScore').innerText == ' ' || document.getElementById('bestScore').innerText < gameData.score)
              document.getElementById('bestScore').innerText = gameData.score;
          }
          num_set();
        }
      };

      function button_start() {
        setGame();
        for (let i = 0; i < gameData.mode; i++) {
          for (let j = 0; j < gameData.mode; j++) {
            gameData.table.current[i][j] = null;
          }
        }
        gameData.score = 0;
        gameData.state = 1;
        document.getElementById('score').innerText = gameData.score;
        creatnum();
        num_set();
      }

      function button_undo() {
        if (gameData.state === 1) {
          for (let i = 0; i < gameData.mode; i++) {
            for (let j = 0; j < gameData.mode; j++) {
              document.getElementById('tb_' + i + j).innerText = gameData.table.before[i][j];
              colorcg(i * gameData.mode + j, gameData.table.before[i][j]);
            }
          }
        }
      }

      function fail_check() {
        if (datacheck() === gameData.mode * gameData.mode && space_check() === 2) {
          let cnt = 0;
          for (let i = 0; i < gameData.mode - 1; i++) {
            for (let j = 0; j < gameData.mode - 1; j++) {
              if (
                gameData.table.current[i][j] !== null &&
                (gameData.table.current[i][j] === gameData.table.current[i][j + 1] ||
                  gameData.table.current[i][j] === gameData.table.current[i + 1][j])
              )
                cnt++;
            }
          }
          return cnt;
          console.log(cnt);
        }
      }

      function creatnum() {
        if (space_check() === 1) {
          while (1) {
            let num = randnum(gameData.mode * gameData.mode);
            if (gameData.table.current[get_num(num)[0]][get_num(num)[1]] === null) {
              gameData.table.current[get_num(num)[0]][get_num(num)[1]] = randnum(10) < 2 ? 4 : 2;
              break;
            }
          }
        }
      }

      function colorSet(space, bg, num) {
        const blockColor = document.querySelectorAll('div.block_' + gameData.mode);
        blockColor[space].style.background = bg;
        blockColor[space].style.color = num;
      }

      function colorcg(space, num) {
        if (num > 2048) num = 2048;

        switch (num) {
          case null:
            colorSet(space, '#D4CDC5', 'none');
            break;
          case 2:
            colorSet(space, '#ECE3DA', '#685F58');
            break;
          case 4:
            colorSet(space, '#EADFC9', '#685F58');
            break;
          case 8:
            colorSet(space, '#E7B383', '#FFF5DE');
            break;
          case 16:
            colorSet(space, '#E7996B', '#FFF5DE');
            break;
          case 32:
            colorSet(space, '#E58366', '#FFF5DE');
            break;
          case 64:
            colorSet(space, '#E46747', '#FFF5DE');
            break;
          case 128:
            colorSet(space, '#E9D07E', '#FFF5DE');
            break;
          case 256:
            colorSet(space, '#E7C07E', '#FFF5DE');
            break;
          case 512:
            colorSet(space, '#E7CA66', '#FFF5DE');
            break;
          case 1024:
            colorSet(space, '#ff685d', '#333333');
            break;
          case 2048:
            colorSet(space, '#ff685d', 'red');
            break;
        }
      }

      function datacopy() {
        for (let i = 0; i < gameData.mode; i++) {
          for (let j = 0; j < gameData.mode; j++) {
            gameData.table.before[i][j] = gameData.table.current[i][j];
          }
        }
      }

      function datacheck() {
        let check = 0;
        for (let i = 0; i < gameData.mode; i++) {
          for (let j = 0; j < gameData.mode; j++) {
            if (gameData.table.before[i][j] === gameData.table.current[i][j]) check += 1;
          }
        }
        return check;
      }

      function space_check() {
        let cnt = 0;
        for (let i = 0; i < gameData.mode; i++) {
          for (let j = 0; j < gameData.mode; j++) {
            if (gameData.table.current[i][j] !== null) cnt++;
          }
        }

        cnt = cnt < gameData.mode * gameData.mode ? 1 : 2;

        return cnt;
      }

      function num_set() {
        for (let i = 0; i < gameData.mode; i++) {
          for (let j = 0; j < gameData.mode; j++) {
            document.getElementById('tb_' + i + j).innerText = gameData.table.current[i][j];
            colorcg(i * gameData.mode + j, gameData.table.current[i][j]);
          }
        }
      }

      function scoreupdate(num) {
        if (!isNaN(num)) {
          gameData.score += num;
          document.getElementById('score').innerText = gameData.score;
        }
      }

      function get_num(num) {
        const rtnum = [0, num];

        if (rtnum[1] > gameData.mode - 1) {
          while (rtnum[1] > gameData.mode - 1) {
            rtnum[1] -= gameData.mode;
            rtnum[0]++;
          }
        }

        return rtnum;
      }
      function mode_change(num) {
        const nowMode = eval(document.getElementById('status_mode').innerText + num);

        if (nowMode > 3 && nowMode < 9) {
          document.getElementById('status_mode').innerText = nowMode;
          gameData.mode = nowMode;
        }
      }

      function randnum(num) {
        return Math.floor(Math.random() * num);
      }
    </script>
  </head>
  <body>
    <div class="main">
      <div class="statusBar">
        <div class="statusBar_1f">
          <div class="titleName" id="test">2048</div>
          <div class="score">점수<br /><br /><span class="scoreNum" id="score">&nbsp;</span></div>
          <div class="score">최고 점수<br /><br /><span class="scoreNum" id="bestScore">&nbsp;</span></div>
        </div>
        <div class="statusBar_2f">
          <div><input class="_button" type="button" value="START" onclick="button_start()" /></div>
          <div><input class="_button" type="button" value="UNDO" onclick="button_undo()" /></div>
          <div class="modeSelector" id="select_mode">
            <div class="button_div"><input class="_button" type="button" value="▶" onclick="mode_change('+1');" /></div>
            <div class="button_div"><span class="modLevel" id="status_mode">4</span></div>
            <div class="button_div"><input class="_button" type="button" value="◀" onclick="mode_change('-1');" /></div>
          </div>
        </div>
      </div>
      <div class="gameboard_4" id="gameboard1"></div>
    </div>
  </body>
</html>
